<script>
// ====== CẤU HÌNH ======
const SECTION_DEFS = [
  { key: 'mua2tang1',   label: 'Mục 1: CHƯƠNG TRÌNH “MUA 2 TẶNG 1"',       sheet: 'MUA2TANG1' },
  { key: 'mua1tang1',   label: 'Mục 2: CHƯƠNG TRÌNH “MUA 1 TẶNG 1"',       sheet: 'MUA1TANG1' },
  { key: 'trungthu',    label: 'Mục 3: CHƯƠNG TRÌNH TRUNG THU',            sheet: 'TRUNGTHU' },
  { key: 'giam50nuocep',label: 'Mục 4: CHƯƠNG TRÌNH GIẢM 50% NƯỚC ÉP LON', sheet: 'GIAM50_NUOCEP' },
  { key: 'hangtuuuhco', label: 'Mục 5: CHƯƠNG TRÌNH HÀNG TƯƠI HỮU CƠ',     sheet: 'HANG_TUOI_HUU_CO' },
];

var state = {
  bigTitle: '',
  sections: (function(){ const o={}; SECTION_DEFS.forEach(d=>o[d.key]=[]); return o; })()
};

function formatVND(n){ if(n===''||n==null||isNaN(Number(n))) return ''; try{return Number(n).toLocaleString('vi-VN')+'₫';}catch(e){return n;} }
function normalizeRow(row){
  function get(aliases){
    for (var i=0;i<aliases.length;i++){
      var a=aliases[i];
      for (var k in row){
        if (!Object.prototype.hasOwnProperty.call(row,k)) continue;
        if ((k||'').toString().trim().toLowerCase()===a) return row[k];
      }
    }
    return '';
  }
  return {
    image: get(['hình ảnh','hinh anh','image','img','url','hình']),
    name:  get(['tên sản phẩm','ten san pham','name','product','sản phẩm']),
    price: get(['giá bán cuối','gia ban cuoi','price','giá','gia']),
    promo: get(['khuyến mãi','khuyen mai','promo','promotion','deal']),
  };
}

// ====== RENDER ======
var sectionsEl = document.getElementById('sections');
var sectionTpl = document.getElementById('sectionTemplate');
var itemTpl    = document.getElementById('itemCardTemplate');
var statusEl   = document.getElementById('status');

function render(){
  sectionsEl.innerHTML = '';
  SECTION_DEFS.forEach(function(def, idx){
    var node = sectionTpl.content.cloneNode(true);
    var sec = node.querySelector('section');
    sec.setAttribute('data-key', def.key);
    sec.querySelector('h2').textContent = def.label;
    sec.querySelector('.pill').textContent = 'Mục ' + (idx+1);
    var wrap = sec.querySelector('.itemsWrap');

    (state.sections[def.key]||[]).forEach(function(it){
      var card = itemTpl.content.cloneNode(true);
      var img  = card.querySelector('.previewImg');
      var nm   = card.querySelector('.nameText');
      var pr   = card.querySelector('.priceText');
      var pm   = card.querySelector('.promoText');

      if (it.image){ img.src = it.image; img.alt = it.name || 'Ảnh'; }
      else { img.parentNode.removeChild(img); }

      nm.textContent = it.name || '';
      pr.textContent = formatVND(it.price);
      pm.textContent = it.promo || '';
      wrap.appendChild(card);
    });

    sectionsEl.appendChild(node);
  });

  var bt = document.getElementById('bigTitle');
  if (bt) bt.value = state.bigTitle || '';
}

// ====== ĐỌC EXCEL (y như dự án đã chạy OK của em) ======
function loadDeals(){
  fetch('deals.xlsx', { cache: 'no-store' })
    .then(function(res){
      if(!res.ok) throw new Error('Không tìm thấy deals.xlsx');
      return res.arrayBuffer();
    })
    .then(function(buf){
      // XLSX phải có sẵn do ta đã <script src="...xlsx.full.min.js">
      var wb = XLSX.read(buf, { type: 'array' });

      // Big Title từ CONFIG (A2 = BIG_TITLE, B2 = value)
      var cfg = wb.Sheets['CONFIG'];
      if (cfg){
        var rows = XLSX.utils.sheet_to_json(cfg, { header:1, defval:'' });
        for (var i=0;i<rows.length;i++){
          var r = rows[i];
          var k = (r[0]||'').toString().trim().toUpperCase();
          if (k === 'BIG_TITLE'){ state.bigTitle = r[1] || ''; break; }
        }
      }

      // Xoá & nạp từng mục
      state.sections = (function(){ const o={}; SECTION_DEFS.forEach(d=>o[d.key]=[]); return o; })();

      var logs = [];
      SECTION_DEFS.forEach(function(def){
        var sh = wb.Sheets[def.sheet];
        if (!sh){ logs.push(def.sheet+' ✗ (không có)'); return; }
        var rows = XLSX.utils.sheet_to_json(sh, { defval:'' });
        var items = rows.map(normalizeRow)
                        .filter(function(x){ return x.name || x.image || x.promo || x.price; });
        state.sections[def.key] = items;
        logs.push(def.sheet+' ✓ ('+items.length+' dòng)');
      });

      if (statusEl){
        statusEl.classList.remove('hidden');
        statusEl.innerHTML = '<div class="text-sm"><b>Trạng thái nạp Excel</b>: '+logs.join(' • ')+'</div>';
      }
      render();
    })
    .catch(function(err){
      showError("Không tải được deals.xlsx. Chi tiết: " + (err && err.message ? err.message : err));
    });
}

// ====== SEARCH (như cũ) ======
function doSearch(q){
  var kw = (q||'').trim().toLowerCase();
  document.querySelectorAll('.itemsWrap article').forEach(function(c){ c.classList.remove('ring-2'); });
  if (!kw) return;
  SECTION_DEFS.forEach(function(def){
    (state.sections[def.key]||[]).forEach(function(it){
      var hit = (it.name||'').toLowerCase().includes(kw) || (it.promo||'').toLowerCase().includes(kw);
      if (hit){
        var card = document.querySelector('section[data-key="'+def.key+'"] article');
        if (card) card.classList.add('ring-2');
      }
    });
  });
}

document.getElementById('searchInput') &&
document.getElementById('searchInput').addEventListener('keydown', function(e){
  if (e.key === 'Enter') doSearch(e.target.value||'');
});

// ====== INIT ======
function showError(msg){
  var box = document.createElement('div');
  box.className = 'card p-4 md:p-6 mb-6 border-red-300 bg-red-50 text-red-800';
  box.innerHTML = '<div class="font-semibold mb-1">Lỗi Excel</div><pre class="text-sm whitespace-pre-wrap">'+(msg||'')+'</pre>';
  document.querySelector('.max-w-7xl').prepend(box);
}
render();
loadDeals();
</script>