<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Danh sách Deal Livestream</title>
  <link rel="icon" href="https://dannygreen.vn/wp-content/uploads/2024/08/DannyGreen-favicon.png" sizes="32x32">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- ƯU TIÊN: Thư viện XLSX local (đặt file này vào public/xlsx.full.min.js) -->
  <script src="/xlsx.full.min.js" defer></script>
  <!-- Fallback CDN nếu local không tải được -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.20.3/dist/xlsx.full.min.js" defer></script>

  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue"; background:#f8fafc; color:#0f172a }
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:1rem;box-shadow:0 1px 2px rgba(0,0,0,.04)}
    .field{width:100%;border:1px solid #cbd5e1;border-radius:.75rem;padding:.5rem .75rem;font-size:.875rem}
    .pill{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.04em;border-radius:9999px;padding:.25rem .625rem;background:#f1f5f9;color:#334155}
    .itemsWrap article {
      min-width: 200px;
      max-width: 220px;
      flex: 0 0 auto;
    }
    .previewWrap { height: 150px; }
  </style>
</head>
<body>
  <div class="max-w-7xl mx-auto p-4 md:p-6">
    <!-- Header -->
    <header class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between mb-4">
      <div class="flex items-center gap-3">
        <img src="https://dannygreen.vn/wp-content/uploads/2024/11/Logo-DannyGreen-R-07.webp" alt="DannyGreen" class="h-10 w-auto rounded-lg border border-slate-200 bg-white p-1"/>
        <div>
          <h1 class="text-2xl md:text-3xl font-extrabold">Deal Tháng 9 Livestream</h1>
        </div>
      </div>
      <div><input id="searchInput" class="field" placeholder="Tìm theo tên sản phẩm/khuyến mãi…"/></div>
    </header>

    <!-- Mục lớn -->
    <section class="card p-4 md:p-6 mb-6">
      <div class="flex flex-col md:flex-row md:items-center gap-3">
        <label class="text-sm font-semibold">Khuyến mãi chung: TẤT CẢ ĐƠN TỪ 299K TẶNG 1 HỘP DƯA LƯỚI SẤY MỘC HỮU CƠ DANNYGREEN TRỊ GIÁ 195K và nhận thêm 1 phần quà bí mật từ shop</label>
        <input id="bigTitle" class="field" disabled />
      </div>
    </section>
    <!-- Status + Sections -->
    <div id="sections" class="space-y-6"></div>

    <footer class="mt-10 text-xs text-slate-500">Made for DannyGreen • v2.2 by Nuttency</footer>
  </div>

  <!-- Templates -->
  <template id="sectionTemplate">
    <section class="card p-4 md:p-6">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-2">
          <span class="pill"></span>
          <h2 class="text-xl font-bold"></h2>
        </div>
      </div>
      <div class="flex gap-4 overflow-x-auto pb-3 itemsWrap"></div>
    </section>
  </template>

  <template id="itemCardTemplate">
    <article class="card overflow-hidden min-w-[220px] flex-[0_0_auto]">
      <div class="previewWrap relative w-full aspect-[4/3] bg-slate-100 overflow-hidden rounded-lg">
        <img class="previewImg absolute inset-0 w-full h-full object-cover" alt="preview"/>
      </div>
      <div class="p-3 space-y-1.5">
        <div class="text-sm font-semibold nameText truncate"></div>
        <div class="text-[13px] text-slate-600 promoText"></div>
        <div class="text-base font-bold priceText"></div>
      </div>
    </article>
  </template>

  <!-- App Script -->
  <script>
  document.addEventListener('DOMContentLoaded', function () {
    // ====== CẤU HÌNH ======
    const SECTION_DEFS = [
      { key: 'mua2tang1',   label: 'CHƯƠNG TRÌNH “MUA 2 TẶNG 1"',       sheet: 'MUA2TANG1' },
      { key: 'mua1tang1',   label: 'CHƯƠNG TRÌNH “MUA 1 TẶNG 1"',       sheet: 'MUA1TANG1' },
      { key: 'trungthu',    label: 'CHƯƠNG TRÌNH TRUNG THU',            sheet: 'TRUNGTHU' },
      { key: 'giam50nuocep',label: 'CHƯƠNG TRÌNH GIẢM 50% NƯỚC ÉP LON', sheet: 'GIAM50_NUOCEP' },
      { key: 'hangtuuuhco', label: 'CHƯƠNG TRÌNH HÀNG TƯƠI HỮU CƠ',     sheet: 'HANG_TUOI_HUU_CO' }
    ];

    var state = {
      bigTitle: '',
      sections: (function(){ var o={}; SECTION_DEFS.forEach(function(d){o[d.key]=[]}); return o; })()
    };

    function formatVND(n){ if(n===''||n==null||isNaN(Number(n))) return ''; try{return Number(n).toLocaleString('vi-VN')+'₫';}catch(e){return n;} }
    function normalizeRow(row){
      function get(aliases){
        for (var i=0;i<aliases.length;i++){
          var a=aliases[i];
          for (var k in row){
            if (!Object.prototype.hasOwnProperty.call(row,k)) continue;
            if ((k||'').toString().trim().toLowerCase()===a) return row[k];
          }
        }
        return '';
      }
      return {
        image: get(['hình ảnh','hinh anh','image','img','url','hình']),
        name:  get(['tên sản phẩm','ten san pham','name','product','sản phẩm']),
        price: get(['giá bán cuối','gia ban cuoi','price','giá','gia']),
        promo: get(['khuyến mãi','khuyen mai','promo','promotion','deal'])
      };
    }

    // ====== DOM ======
    var sectionsEl = document.getElementById('sections');
    var sectionTpl = document.getElementById('sectionTemplate');
    var itemTpl    = document.getElementById('itemCardTemplate');
    var statusEl   = document.getElementById('status');

    function render(){
      sectionsEl.innerHTML = '';
      SECTION_DEFS.forEach(function(def, idx){
        var node = sectionTpl.content.cloneNode(true);
        var sec = node.querySelector('section');
        sec.setAttribute('data-key', def.key);
        sec.querySelector('h2').textContent = def.label;
        sec.querySelector('.pill').textContent = 'Mục ' + (idx+1);
        var wrap = sec.querySelector('.itemsWrap');

        (state.sections[def.key]||[]).forEach(function(it){
          var card = itemTpl.content.cloneNode(true);
          var img  = card.querySelector('.previewImg');
          var nm   = card.querySelector('.nameText');
          var pr   = card.querySelector('.priceText');
          var pm   = card.querySelector('.promoText');

          if (it.image){ img.src = it.image; img.alt = it.name || 'Ảnh'; }
          else { img.parentNode.removeChild(img); }

          nm.textContent = it.name || '';
          pr.textContent = formatVND(it.price);
          pm.textContent = it.promo || '';
          wrap.appendChild(card);
        });

        sectionsEl.appendChild(node);
      });

      var bt = document.getElementById('bigTitle');
      if (bt) bt.value = state.bigTitle || '';
    }

    function showError(msg){
      var box = document.createElement('div');
      box.className = 'card p-4 md:p-6 mb-6 border-red-300 bg-red-50 text-red-800';
      box.innerHTML = '<div class="font-semibold mb-1">Lỗi Excel</div><pre class="text-sm whitespace-pre-wrap">'+(msg||'')+'</pre>';
      document.querySelector('.max-w-7xl').prepend(box);
    }

    // ====== ĐỌC EXCEL ======
    function loadDeals(){
      fetch('deals.xlsx', { cache: 'no-store' })
        .then(function(res){
          if(!res.ok) throw new Error('Không tìm thấy deals.xlsx');
          return res.arrayBuffer();
        })
        .then(function(buf){
          if (!window.XLSX) throw new Error('XLSX chưa sẵn sàng. Kiểm tra /xlsx.full.min.js');
          var wb = XLSX.read(buf, { type: 'array' });

          var cfg = wb.Sheets['CONFIG'];
          if (cfg){
            var rows = XLSX.utils.sheet_to_json(cfg, { header:1, defval:'' });
            for (var i=0;i<rows.length;i++){
              var r = rows[i];
              var k = (r[0]||'').toString().trim().toUpperCase();
              if (k === 'BIG_TITLE'){ state.bigTitle = r[1] || ''; break; }
            }
          }

          state.sections = (function(){ var o={}; SECTION_DEFS.forEach(function(d){o[d.key]=[]}); return o; })();

          var logs = [];
          SECTION_DEFS.forEach(function(def){
            var sh = wb.Sheets[def.sheet];
            if (!sh){ logs.push(def.sheet+' ✗ (không có)'); return; }
            var rows = XLSX.utils.sheet_to_json(sh, { defval:'' });
            var items = rows.map(normalizeRow)
                            .filter(function(x){ return x.name || x.image || x.promo || x.price; });
            state.sections[def.key] = items;
            logs.push(def.sheet+' ✓ ('+items.length+' dòng)');
          });

          if (statusEl){
            statusEl.classList.remove('hidden');
            statusEl.innerHTML = '<div class="text-sm"><b>Trạng thái nạp Excel</b>: '+logs.join(' • ')+'</div>';
          }
          render();
        })
        .catch(function(err){
          showError("Không tải được deals.xlsx. Chi tiết: " + (err && err.message ? err.message : err));
        });
    }

    // Search
    var si = document.getElementById('searchInput');
    if (si) si.addEventListener('keydown', function(e){
      if (e.key === 'Enter'){
        var kw = (e.target.value||'').trim().toLowerCase();
        document.querySelectorAll('.itemsWrap article').forEach(function(c){ c.classList.remove('ring-2'); });
        SECTION_DEFS.forEach(function(def){
          (state.sections[def.key]||[]).forEach(function(it){
            var hit = (it.name||'').toLowerCase().includes(kw) || (it.promo||'').toLowerCase().includes(kw);
            if (hit){
              var card = document.querySelector('section[data-key="'+def.key+'"] article');
              if (card) card.classList.add('ring-2');
            }
          });
        });
      }
    });

    // Start
    render();
    loadDeals();
  });
  </script>
</body>
</html>
