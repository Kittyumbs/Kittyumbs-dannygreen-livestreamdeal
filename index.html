<script>
// ---- Config ----
const SECTION_DEFS = [
  { key: 'mua2tang1', label: 'Mục 1: CHƯƠNG TRÌNH “MUA 2 TẶNG 1"', sheet: 'MUA2TANG1' },
  { key: 'mua1tang1', label: 'Mục 2: CHƯƠNG TRÌNH “MUA 1 TẶNG 1"', sheet: 'MUA1TANG1' },
  { key: 'trungthu',  label: 'Mục 3: CHƯƠNG TRÌNH TRUNG THU', sheet: 'TRUNGTHU' },
  { key: 'giam50nuocep', label: 'Mục 4: CHƯƠNG TRÌNH GIẢM 50% NƯỚC ÉP LON', sheet: 'GIAM50_NUOCEP' },
  { key: 'hangtuuuhco', label: 'Mục 5: CHƯƠNG TRÌNH HÀNG TƯƠI HỮU CƠ', sheet: 'HANG_TUOI_HUU_CO' },
];

const CANDIDATE_PATHS = [ '/deals.xlsx', './deals.xlsx', 'deals.xlsx' ];

// ---- State ----
var state = {
  bigTitle: '',
  sections: (function(){ var o={}; SECTION_DEFS.forEach(function(d){o[d.key]=[]}); return o; })()
};

// ---- Utils ----
function formatVND(n){
  if (n === '' || n === null || n === undefined || isNaN(Number(n))) return '';
  try { return Number(n).toLocaleString('vi-VN') + '₫'; } catch(e) { return n; }
}

function normalizeRow(row){
  function get(aliases){
    for (var i=0;i<aliases.length;i++){
      var a = aliases[i];
      for (var k in row){
        if (Object.prototype.hasOwnProperty.call(row,k)){
          var kk = (k||'').toString().trim().toLowerCase();
          if (kk === a) return row[k];
        }
      }
    }
    return '';
  }
  return {
    image: get(['hình ảnh','hinh anh','image','img','url','hình']),
    name:  get(['tên sản phẩm','ten san pham','name','product','sản phẩm']),
    price: get(['giá bán cuối','gia ban cuoi','price','giá','gia']),
    promo: get(['khuyến mãi','khuyen mai','promo','promotion','deal'])
  };
}

// ---- Render ----
var sectionsEl = document.getElementById('sections');
var sectionTpl = document.getElementById('sectionTemplate');
var itemTpl = document.getElementById('itemCardTemplate');

function render(){
  sectionsEl.innerHTML = '';
  SECTION_DEFS.forEach(function(def, idx){
    var node = sectionTpl.content.cloneNode(true);
    var sec = node.querySelector('section');
    sec.setAttribute('data-key', def.key);
    sec.querySelector('h2').textContent = def.label;
    sec.querySelector('.pill').textContent = 'Mục ' + (idx + 1);
    var wrap = sec.querySelector('.itemsWrap');

    var items = state.sections[def.key] || [];
    items.forEach(function(it){
      var card = itemTpl.content.cloneNode(true);
      var el = card.querySelector('article');
      el.setAttribute('data-id', it.id || Math.random().toString(36).slice(2));
      var img = card.querySelector('.previewImg');
      var nm  = card.querySelector('.nameText');
      var pr  = card.querySelector('.priceText');
      var pm  = card.querySelector('.promoText');

      if (it.image) { img.src = it.image; img.alt = it.name || 'Ảnh'; } else { img.parentNode.removeChild(img); }
      nm.textContent = it.name || '';
      pm.textContent = it.promo || '';
      pr.textContent = formatVND(it.price);
      wrap.appendChild(card);
    });

    sectionsEl.appendChild(node);
  });

  var bt = document.getElementById('bigTitle');
  if (bt) bt.value = state.bigTitle || '';
}

// ---- Excel Loader ----
async function loadFromUrlOnce(path){
  var url = path + (path.indexOf('?')>=0 ? '' : ('?t=' + Date.now()));
  console.log('[fetch] trying:', url);
  var res = await fetch(url, { cache: 'no-store' });
  if (!res.ok) throw new Error('HTTP ' + res.status + ' at ' + path);
  var buf = await res.arrayBuffer();
  var wb = XLSX.read(buf, { type: 'array' });
  console.log('[fetch] success:', path, 'sheets:', wb.SheetNames);
  applyWorkbook(wb);
}

async function loadFromCandidates(){
  var lastErr = null;
  for (var i=0;i<CANDIDATE_PATHS.length;i++){
    var p = CANDIDATE_PATHS[i];
    try { await loadFromUrlOnce(p); return; }
    catch(e){ lastErr = e; }
  }
  showError(
    "Không tìm thấy 'deals.xlsx'.\n" +
    "• Deploy Vercel: đặt file vào thư mục PUBLIC và truy cập qua /deals.xlsx.\n" +
    "• Kiểm tra trực tiếp URL: /deals.xlsx\n" +
    "Chi tiết: " + (lastErr && lastErr.message ? lastErr.message : '')
  );
}

function applyWorkbook(wb){
  var statusEl = document.getElementById('status');
  var logs = [];

  var cfg = wb.Sheets['CONFIG'];
  if (cfg){
    var data = XLSX.utils.sheet_to_json(cfg, { header:1, defval:'' });
    for (var i=0;i<data.length;i++){
      var row = data[i];
      var k = (row[0]||'').toString().trim().toUpperCase();
      if (k === 'BIG_TITLE'){ state.bigTitle = row[1] || ''; break; }
    }
    logs.push('CONFIG ✓');
  } else {
    logs.push('CONFIG ✗ (không có)');
  }

  // clear
  state.sections = (function(){ var o={}; SECTION_DEFS.forEach(function(d){o[d.key]=[]}); return o; })();

  SECTION_DEFS.forEach(function(def){
    var sh = wb.Sheets[def.sheet];
    if (!sh){ logs.push(def.sheet + ' ✗ (không có)'); return; }
    var rows = XLSX.utils.sheet_to_json(sh, { defval:'' });
    var items = rows.map(function(r){ return normalizeRow(r); })
                   .filter(function(x){ return x.name || x.image || x.promo || x.price; });
    state.sections[def.key] = items;
    logs.push(def.sheet + ' ✓ (' + items.length + ' dòng)');
  });

  render();

  if (statusEl){
    statusEl.classList.remove('hidden');
    statusEl.innerHTML =
      '<div class="text-sm"><b>Trạng thái nạp Excel</b>: ' + logs.join(' • ') + '</div>';
  }
}

// ---- Search ----
function doSearch(q){
  var kw = (q||'').trim().toLowerCase();
  var allCards = document.querySelectorAll('.itemsWrap article');
  allCards.forEach(function(c){ c.classList.remove('ring-2','ring-[color:var(--accent)]'); });
  if (!kw) return;
  SECTION_DEFS.forEach(function(def){
    (state.sections[def.key] || []).forEach(function(it){
      var hit = (it.name||'').toLowerCase().includes(kw) || (it.promo||'').toLowerCase().includes(kw);
      if (hit){
        var card = document.querySelector('section[data-key="'+def.key+'"] article[data-id]');
        if (card) card.classList.add('ring-2','ring-[color:var(--accent)]');
      }
    });
  });
}

// ---- Events ----
document.getElementById('searchInput').addEventListener('keydown', function(e){
  if (e.key === 'Enter') doSearch(e.target.value || '');
});

// ---- Init ----
render();
loadFromCandidates();

function showError(msg){
  var box = document.createElement('div');
  box.className = 'card p-4 md:p-6 mb-6 border-red-300 bg-red-50 text-red-800';
  box.innerHTML = '<div class="font-semibold mb-1">Lỗi tải Excel</div>' +
                  '<pre class="text-sm whitespace-pre-wrap">' + (msg||'') + '</pre>';
  var root = document.querySelector('.max-w-7xl');
  if (root) root.prepend(box);
  console.warn(msg);
}
</script>
